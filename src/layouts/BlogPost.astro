---
import type { CollectionEntry } from 'astro:content';
import { getCollection } from 'astro:content';
import { Image } from 'astro:assets';
import BaseHead from '../components/BaseHead.astro';
import Breadcrumb from '../components/Breadcrumb.astro';
import Footer from '../components/Footer.astro';
import FormattedDate from '../components/FormattedDate.astro';
import Header from '../components/Header.astro';
import '../styles/blog-post.css';
import '../styles/books.css';
import '../styles/cookie-banner.css';

// Import dynamique de toutes les images de src/assets/
const allImages = import.meta.glob<{ default: ImageMetadata }>(
  '/src/assets/**/*.{png,jpg,jpeg,webp,avif}',
  { eager: true }
);

// Fonction pour trouver une image dans src/assets à partir d'un chemin /images/...
function findAssetImage(imagePath: string): ImageMetadata | null {
  if (!imagePath || imagePath.includes('/images/ia/')) return null;

  // Extraire le nom de fichier
  const filename = imagePath.split('/').pop();
  if (!filename) return null;

  // Déterminer le dossier cible dans src/assets
  let targetFolder = 'divers';
  if (imagePath.includes('/images/esp/')) targetFolder = 'esp';
  else if (imagePath.includes('/images/russe/')) targetFolder = 'russe';

  // Chercher dans le dossier approprié
  const assetPath = `/src/assets/${targetFolder}/${filename}`;
  if (allImages[assetPath]) {
    return allImages[assetPath].default;
  }

  // Fallback: chercher par nom de fichier dans tous les dossiers
  for (const [path, module] of Object.entries(allImages)) {
    if (path.endsWith(`/${filename}`)) {
      return module.default;
    }
  }

  return null;
}

type BlogData = CollectionEntry<'blog'>['data'];

type ExtraProps = {
  heroImageLink?: string;
  heroImageAlt?: string;
  pageTitle?: string;
  hideTitle?: boolean;
  hideBreadcrumb?: boolean;
  tags?: string[];
};

// → on rend draft optionnel côté layout
type Props = Omit<BlogData, 'draft'> & { draft?: boolean } & ExtraProps;

const {
  title,
  displayTitle,
  description,
  pubDate,
  updatedDate,
  heroImage: heroImageRaw,
  heroImageLink,
  heroImageAlt,
  pageTitle,
  hideTitle,
  hideBreadcrumb = false,
  tags = [],
  draft = false, // valeur par défaut (même si non utilisé)
  lang = 'fr',
} = Astro.props as Props;

// Titre affiché : displayTitle > pageTitle > title
const shownTitle = displayTitle ?? pageTitle ?? title;


// --- Normalisation & heuristiques pour compat ancien/nouveau ---

// Convertit "public/..." en "/..." ; laisse http(s) intact ; ajoute "/" si besoin
function normalize(src?: string | null) {
  if (!src) return null;
  if (src.startsWith("http://") || src.startsWith("https://")) return src;
  const s = src.replace(/^public\//, ""); // Astro sert /public à la racine
  return s.startsWith("/") ? s : `/${s}`;
}

const FALLBACK = "/images/placeholders/hero-portrait.png";

const heroImage = normalize(heroImageRaw) ?? FALLBACK;
const alt = heroImageAlt ?? (title ? `Illustration : ${title}` : "Illustration");

// Heuristique :
// - Nouveaux articles IA : PNG sous /images/ia/...  => <Picture> (AVIF/WEBP/PNG)
// - Articles avec image dans src/assets => <Image> (optimisation auto AVIF/WEBP)
// - Fallback => <img> simple
const isPng = /\.png$/i.test(heroImage);
const isUnderIA = heroImage.includes("/images/ia/");
const usePicture = isPng && isUnderIA;

// Pour <picture>, on part de la base sans extension
const pictureBase = usePicture ? heroImage.replace(/\.png$/i, "") : null;

// Chercher l'image dans src/assets (pour les articles manuels)
const assetImage = !usePicture ? findAssetImage(heroImage) : null;

// Schema.org Article JSON-LD
const SITE_URL = 'https://phdefoy.com';
const currentUrl = Astro.url.pathname;
const absoluteImage = heroImage.startsWith('http') ? heroImage : `${SITE_URL}${heroImage}`;

const articleSchema = {
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": title,
  "description": description,
  "image": absoluteImage,
  "datePublished": pubDate instanceof Date ? pubDate.toISOString() : new Date(pubDate).toISOString(),
  ...(updatedDate && { "dateModified": updatedDate instanceof Date ? updatedDate.toISOString() : new Date(updatedDate).toISOString() }),
  "author": {
    "@type": "Person",
    "name": "Philippe de Foy",
    "url": `${SITE_URL}/philippe-de-foy/`
  },
  "publisher": {
    "@type": "Organization",
    "name": "Philippe de Foy",
    "url": SITE_URL,
    "logo": {
      "@type": "ImageObject",
      "url": `${SITE_URL}/favicon.svg`
    }
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": `${SITE_URL}${currentUrl}`
  }
};

// Helpers pour les URLs
const cleanId = (id: string) => id.replace(/^.*\//, '').replace(/^\d{4}-\d{2}-\d{2}-/, '');
const hrefFor = (p: CollectionEntry<'blog'>) => `/${cleanId(p.id)}/`;

// Articles similaires - manuel via relatedArticles dans le frontmatter
const relatedSlugs = (Astro.props as any).relatedArticles || [];
let relatedArticles: CollectionEntry<'blog'>[] = [];

if (relatedSlugs.length > 0) {
  const allPosts = await getCollection('blog', (p) => !p.data.draft);
  relatedArticles = relatedSlugs
    .map((slug: string) => allPosts.find((p) => cleanId(p.id) === slug || p.id.includes(slug)))
    .filter(Boolean) as CollectionEntry<'blog'>[];
}

// Articles de la même catégorie (Russe ou Espagnol) - automatique
const categoryTag = tags.find((t: string) => t === 'Russe' || t === 'Espagnol');
let categoryArticles: CollectionEntry<'blog'>[] = [];

if (categoryTag) {
  const allPosts = await getCollection('blog', (p) => !p.data.draft);

  // Filtrer les articles de la même catégorie, exclure l'article courant, tri par date
  categoryArticles = allPosts
    .filter((p) => p.data.tags?.includes(categoryTag) && !currentUrl.includes(cleanId(p.id)))
    .sort((a, b) => new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime());
}
---

<html lang={lang}>
  <head>
    <BaseHead
      title={title}
      description={description}
      image={heroImage}
      imageAlt={alt}
      ogType="article"
    />
    <!-- Schema.org Article -->
    <script type="application/ld+json" set:html={JSON.stringify(articleSchema)} />
   </head>
  <body class="blog">
    <Header />
    {!hideBreadcrumb && <Breadcrumb title={title} tags={tags} />}
    <main>
      <article class="post-content">
        <div class="hero-image">
          {
            heroImageLink ? (
              <a
                href={heroImageLink}
                target="_blank"
                rel="noopener sponsored noreferrer"
                class="hero-image-link"
                aria-label={`Voir le livre sur Amazon`}
              >
                {
                  usePicture ? (
                    <picture>
                      <source srcset={`${pictureBase}.avif`} type="image/avif" />
                      <source srcset={`${pictureBase}.webp`} type="image/webp" />
                      <img src={`${pictureBase}.png`} alt={alt} width="1200" height="630" fetchpriority="high" decoding="async" />
                    </picture>
                  ) : assetImage ? (
                    <Image src={assetImage} alt={alt} width={1200} height={630} format="avif" loading="eager" decoding="async" />
                  ) : (
                    <img src={heroImage} alt={alt} width="1200" height="630" fetchpriority="high" decoding="async" />
                  )
                }
                <span class="badge-amazon">Voir sur Amazon</span>
              </a>
            ) : (
              usePicture ? (
                <picture>
                  <source srcset={`${pictureBase}.avif`} type="image/avif" />
                  <source srcset={`${pictureBase}.webp`} type="image/webp" />
                  <img src={`${pictureBase}.png`} alt={alt} width="1200" height="630" fetchpriority="high" decoding="async" />
                </picture>
              ) : assetImage ? (
                <Image src={assetImage} alt={alt} width={1200} height={630} format="avif" loading="eager" decoding="async" />
              ) : (
                <img src={heroImage} alt={alt} width="1200" height="630" fetchpriority="high" decoding="async" />
              )
            )
          }
        </div>

        <div class="prose">
          {!hideTitle && (
            <div class="title">
              <div class="date">
                <FormattedDate date={pubDate} />
                {updatedDate && (
                  <div class="last-updated-on">
                    Dernière mise à jour : <FormattedDate date={updatedDate} />
                  </div>
                )}
              </div>

              <h1>{shownTitle}</h1>
              <hr />
            </div>
          )}

          <slot />
        </div>
      </article>

      {relatedArticles.length > 0 && (
        <section class="related-articles">
          <h2>Livres à découvrir</h2>
          <div class="related-grid">
            {relatedArticles.map((article) => {
              const heroImg = article.data.heroImage;
              const isIa = heroImg?.includes('/images/ia/');
              const isPngImg = /\.png$/i.test(heroImg || '');
              const useRelatedPicture = isIa && isPngImg;
              const relatedPictureBase = useRelatedPicture ? heroImg.replace(/\.png$/i, '') : null;
              const relatedAssetImg = !useRelatedPicture ? findAssetImage(heroImg || '') : null;

              return (
                <a href={hrefFor(article)} class="related-card">
                  {heroImg && (
                    useRelatedPicture && relatedPictureBase ? (
                      <picture>
                        <source srcset={`${relatedPictureBase}.avif`} type="image/avif" />
                        <source srcset={`${relatedPictureBase}.webp`} type="image/webp" />
                        <img
                          src={`${relatedPictureBase}.png`}
                          alt={article.data.heroImageAlt || article.data.title}
                          loading="lazy"
                          decoding="async"
                        />
                      </picture>
                    ) : relatedAssetImg ? (
                      <Image
                        src={relatedAssetImg}
                        alt={article.data.heroImageAlt || article.data.title}
                        width={400}
                        height={225}
                        format="avif"
                        loading="lazy"
                        decoding="async"
                      />
                    ) : (
                      <img
                        src={heroImg}
                        alt={article.data.heroImageAlt || article.data.title}
                        loading="lazy"
                        decoding="async"
                      />
                    )
                  )}
                  <h3>{article.data.displayTitle ?? article.data.title}</h3>
                  <div class="meta">
                    <FormattedDate date={article.data.pubDate} />
                  </div>
                </a>
              );
            })}
          </div>
        </section>
      )}

      {categoryArticles.length > 0 && (
        <section class="articles-section">
          <div class="articles-container">
            <h2>Tous les articles - {categoryTag}</h2>
            <ul class="post-list">
              {categoryArticles.map((article) => {
                const heroImg = article.data.heroImage;
                const isIa = heroImg?.includes('/images/ia/');
                const isPngImg = /\.png$/i.test(heroImg || '');
                const useCategoryPicture = isIa && isPngImg;
                const categoryPictureBase = useCategoryPicture ? heroImg.replace(/\.png$/i, '') : null;
                const categoryAssetImg = !useCategoryPicture ? findAssetImage(heroImg || '') : null;

                return (
                  <li class="post-item">
                    <a href={hrefFor(article)} class="post-link">
                      {heroImg && (
                        useCategoryPicture && categoryPictureBase ? (
                          <picture>
                            <source srcset={`${categoryPictureBase}.avif`} type="image/avif" />
                            <source srcset={`${categoryPictureBase}.webp`} type="image/webp" />
                            <img
                              src={`${categoryPictureBase}.png`}
                              alt={article.data.heroImageAlt || article.data.title}
                              loading="lazy"
                              decoding="async"
                            />
                          </picture>
                        ) : categoryAssetImg ? (
                          <Image
                            src={categoryAssetImg}
                            alt={article.data.heroImageAlt || article.data.title}
                            width={640}
                            height={360}
                            format="avif"
                            loading="lazy"
                            decoding="async"
                          />
                        ) : (
                          <img
                            src={heroImg}
                            alt={article.data.heroImageAlt || article.data.title}
                            loading="lazy"
                            decoding="async"
                          />
                        )
                      )}
                      <h3>{article.data.displayTitle ?? article.data.title}</h3>
                    </a>
                  </li>
                );
              })}
            </ul>
          </div>
        </section>
      )}
    </main>
    <Footer />

    <style>
      .related-articles {
        max-width: 900px;
        margin: 3rem auto;
        padding: 2rem;
        background: rgba(30, 41, 59, 0.4);
        border-radius: 16px;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .related-articles h2 {
        color: #60a5fa;
        font-size: 1.5rem;
        margin: 0 0 1.5rem 0;
        text-align: center;
      }

      .related-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1.5rem;
      }

      .related-card {
        background: rgba(30, 41, 59, 0.6);
        backdrop-filter: blur(10px);
        border-radius: 12px;
        overflow: hidden;
        text-decoration: none;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid rgba(255, 255, 255, 0.08);
      }

      .related-card:hover {
        transform: translateY(-4px);
        background: rgba(30, 41, 59, 0.8);
        border-color: rgba(255, 255, 255, 0.2);
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.3);
      }

      .related-card img {
        width: 100%;
        height: auto;
        aspect-ratio: 16/9;
        object-fit: cover;
      }

      .related-articles .related-card h3 {
        color: #cbd5e1 !important;
        font-size: 0.95rem !important;
        margin: 0.15rem 0.75rem 0.3rem !important;
        padding: 0 !important;
        line-height: 1.4 !important;
        transition: color 0.2s ease;
      }

      .related-articles .related-card:hover h3 {
        color: #7dd3fc !important;
      }

      .related-card .meta {
        margin: 0 0.75rem 0.75rem;
        color: #94a3b8 !important;
        font-size: 0.85rem;
      }

      .related-card .meta time {
        color: #94a3b8 !important;
      }

      @media (max-width: 768px) {
        .related-grid {
          grid-template-columns: 1fr;
        }
      }

      /* Section articles de la même catégorie (même style que pages pillar) */
      .articles-section {
        max-width: 900px;
        margin: 2rem auto 0;
        padding: 0 1rem;
      }

      .articles-container {
        background: rgba(30, 41, 59, 0.85);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        padding: 2rem;
      }

      @supports (backdrop-filter: blur(10px)) {
        @media (hover: hover) and (pointer: fine) {
          .articles-container {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(10px);
          }
        }
      }

      .articles-section h2 {
        font-size: 1.5rem;
        margin: 0 0 1.5rem 0;
        line-height: 1.3;
        color: #60a5fa;
        text-align: center;
      }

      .post-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: grid;
        gap: 1.25rem;
        grid-template-columns: repeat(1, minmax(0, 1fr));
      }

      @media (min-width: 640px) {
        .post-list {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
      }

      @media (min-width: 1024px) {
        .post-list {
          grid-template-columns: repeat(3, minmax(0, 1fr));
        }
      }

      .post-item {
        background: rgba(30, 41, 59, 0.85);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        overflow: hidden;
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                    background 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                    border-color 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                    box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      @supports (backdrop-filter: blur(10px)) {
        @media (hover: hover) and (pointer: fine) {
          .post-item {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(10px);
          }
        }
      }

      .post-item:hover {
        transform: translateY(-4px);
        background: rgba(30, 41, 59, 0.9);
        border-color: rgba(255, 255, 255, 0.2);
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.3);
      }

      @media (hover: none) {
        .post-item {
          transition: none;
        }
        .post-item:hover {
          transform: none;
        }
      }

      .post-link {
        display: block;
        text-decoration: none;
        color: #f1f5f9 !important;
      }

      .post-link:visited {
        color: #f1f5f9 !important;
      }

      .post-link img {
        width: 100%;
        height: auto;
        display: block;
        aspect-ratio: 16/9;
        object-fit: cover;
      }

      .post-link:hover {
        color: #7dd3fc !important;
      }

      .post-link:hover h3 {
        color: #7dd3fc !important;
      }

      .post-link h3 {
        margin: 0.6rem 0.75rem 0.75rem;
        font-size: 0.95rem;
        line-height: 1.4;
        color: #cbd5e1 !important;
      }
    </style>

    <!-- Bandeau cookies (AEPD - Espagne) -->
    <div id="cookie-banner">
      <div class="cookie-content">
        <p>Utilizamos cookies propias y de terceros para analizar nuestros servicios y mejorar su experiencia.
           Consulte nuestro <a href="/aviso-legal-y-privacidad/">Aviso Legal y Privacidad</a> para más información.</p>
        <div class="cookie-buttons">
          <button class="btn-accept">Aceptar todas</button>
          <button class="btn-reject">Rechazar todas</button>
          <button class="btn-settings">Configurar</button>
        </div>
      </div>
    </div>

    <!-- Modal de configuration cookies -->
    <div id="cookie-settings-modal">
      <div class="modal-content">
        <h3>Configuración de cookies</h3>
        <div class="cookie-option">
          <label>
            <strong>Cookies Técnicas</strong> (Obligatorias)
            <input type="checkbox" checked disabled>
          </label>
          <p>Necesarias para el correcto funcionamiento del sitio web.</p>
        </div>
        <div class="cookie-option">
          <label>
            <strong>Cookies de Análisis</strong> (Google Analytics)
            <input type="checkbox" id="analytics-checkbox">
          </label>
          <p>Nos ayudan a entender cómo interactúan los visitantes con la web de forma anónima.</p>
        </div>
        <div class="modal-buttons">
          <button class="btn-save">Guardar configuración</button>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="/scripts/consent.js" defer></script>
    <script src="/scripts/downloads.js" defer></script>
  </body>
</html>
