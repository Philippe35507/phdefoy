---
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import Header from '../components/Header.astro';
import FormattedDate from '../components/FormattedDate.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../consts';

import type { CollectionEntry } from "astro:content";
import { getCollection } from "astro:content";

// 1) R√©cup√®re et TRIE les posts (plus r√©cents en premier)
const toTime = (d: unknown) =>
  d instanceof Date ? d.getTime() : (new Date(d as string).getTime() || 0);

const posts: CollectionEntry<'blog'>[] = (await getCollection('blog', (p) => !p.data.draft))
  .sort((a, b) => toTime(b.data.pubDate) - toTime(a.data.pubDate));

// 2) URLs SANS /blog (root) : /<slug>  (id = "ia/mon-fichier" ‚Üí "mon-fichier")
const hrefFor = (p: CollectionEntry<'blog'>) => `/${p.id.replace(/^ia\//, "")}/`;

// 3) Import d‚Äôun fichier Markdown pour le bloc de texte de la home
interface MarkdownModule {
  Content: any;
  frontmatter?: any;
}
const mdModules = import.meta.glob<MarkdownModule>('../content/blog/apprendre-espagnol-et-russe-methodes-efficaces-pour-francophones.md');
const mdModule = await mdModules['../content/blog/apprendre-espagnol-et-russe-methodes-efficaces-pour-francophones.md']();
const { Content } = mdModule;

// 4) Petite util pour fallback d‚Äôimage
function imgOrPlaceholder(src?: string) {
  return src && src.length ? src : "/images/placeholders/inline-1024.png";
}
---

<!doctype html>
<html lang="fr">
  <head>
    <BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
    <!-- CSS sp√©cifiques -->
    <link rel="stylesheet" href="/styles/cookie-banner.css" />
<!-- Balises hreflang pour le multilingue -->
<link rel="alternate" hreflang="fr" href="https://phdefoy.com/" />
<link rel="alternate" hreflang="es" href="https://phdefoy.com/descargas/" />
<link rel="alternate" hreflang="x-default" href="https://phdefoy.com/" />
  </head>

  <body class="page-bg home">
    <Header />
    <main>
      <!-- ===== SECTION WELCOME / DOWNLOADS ===== -->
      <section class="welcome-container">
        <h1>Bienvenue - Cours et ressources pour apprendre l‚Äôespagnol et le russe</h1>
        <h2>
          <span class="icon-books" aria-hidden="true">üìö</span>
          Choisissez vos audios √† t√©l√©charger
        </h2>

        <div class="intro"></div>

        <div class="downloads-grid">
          <!-- A1 -->
          <div class="download-card level-a1">
            <div class="card-content">
              <h3>Espagnol niveau A1</h3>
              <button id="btn-a1" class="download-btn" aria-label="T√©l√©charger les dialogues Espagnol A1">
                T√©l√©charger
              </button>
              <div id="download-container-a1" class="download-container" aria-live="polite"></div>
            </div>
          </div>

          <!-- A2 -->
          <div class="download-card level-a2">
            <div class="card-content">
              <h3>Espagnol niveau A2</h3>
              <button id="btn-a2" class="download-btn" aria-label="T√©l√©charger les dialogues Espagnol A2">
                T√©l√©charger
              </button>
              <div id="download-container-a2" class="download-container" aria-live="polite"></div>
            </div>
          </div>

          <!-- B1 -->
          <div class="download-card level-b1">
            <div class="card-content">
              <h3>Espagnol niveau B1</h3>
              <button id="btn-b1" class="download-btn" aria-label="T√©l√©charger les dialogues Espagnol B1">
                T√©l√©charger
              </button>
              <div id="download-container-b1" class="download-container" aria-live="polite"></div>
            </div>
          </div>
        </div>
      </section>


      <section class="welcome-container">
        <div class="downloads-grid">
          <!-- A1 -->
          <div class="download-card level-a1">
            <div class="card-content">
              <h3>Russe niveau A1</h3>
              <button id="btn-russe-a1" class="download-btn" aria-label="T√©l√©charger Audio Russe A1">
                T√©l√©charger
              </button>
              <div id="download-container-russe-a1" class="download-container" aria-live="polite"></div>
            </div>
          </div>

          <!-- A2 -->
          <div class="download-card level-a2">
            <div class="card-content">
              <h3>Russe niveau A2</h3>
              <button id="btn-russe-a2" class="download-btn" aria-label="T√©l√©charger Audio Russe A2">
                T√©l√©charger
              </button>
              <div id="download-container-russe-a2" class="download-container" aria-live="polite"></div>
            </div>
          </div>

          <!-- B1 -->
          <div class="download-card level-b1">
            <div class="card-content">
              <h3>Russe niveau B1</h3>
              <button id="btn-russe-b1" class="download-btn" aria-label="T√©l√©charger Audio Russe B1">
                T√©l√©charger
              </button>
              <div id="download-container-russe-b1" class="download-container" aria-live="polite"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- ===== SECTION TEXTE (Markdown d√©di√© √† la home) ===== -->
      <section class="blog-section">
        <div class="blog-container">
          <Content />
        </div>
      </section>

      {/*
        ====== SECTION ‚ÄúDERNIERS ARTICLES‚Äù ======
        üëâ Si tu ne veux PAS de liste d‚Äôarticles sur la home, supprime ce bloc.
      */}
      <section class="latest-posts">
        <div class="latest-container">
          <h2 class="derniersarticles">Derniers articles</h2>

          <div class="posts-grid">
            {posts.map((p) => (
              <article class="post-card">
                <a class="post-link" href={hrefFor(p)} aria-label={`Lire : ${p.data.title}`}>
                  <img
                    width={480}
                    height={320}
                    src={imgOrPlaceholder(p.data.heroImage)}
                    alt={p.data.heroImageAlt ?? `Illustration : ${p.data.title}`}
                    loading="lazy"
                    decoding="async"
                    fetchpriority="low"
                  />
                  <h3 class="post-title">{p.data.title}</h3>
                </a>
                <div class="post-meta">
                  <FormattedDate date={p.data.pubDate} />
                </div>
              </article>
            ))}
          </div>
        </div>
      </section>

      <style>
        /* ===== THEME GLOBAL ===== */
        body.page-bg {
          min-height: 100vh;
          background: linear-gradient(135deg, #12141f 0%, #1a1c2b 40%, #23254a 100%);
          margin: 0;
          font-family: var(--font-sans);
        }
        main { padding-top: 0; margin-top: -20px; }

        /* ===== SECTION BLOG (bloc Markdown) ===== */
        .blog-section {
          max-width: 900px;
          margin: 2rem auto;
          padding: 0 2rem;
          color: #f8fafc;
        }
        .blog-container {
          background: rgba(30, 41, 59, 0.6);
          backdrop-filter: blur(10px);
          border: 1px solid rgba(255, 255, 255, 0.1);
          border-radius: 16px;
          padding: 3rem;
          margin-bottom: 4rem;
          line-height: 1.7;
        }
        .blog-container :global(h1) {
          font-size: clamp(2rem, 5vw, 2.5rem);
          color: #f8fafc;
          font-weight: 700;
          letter-spacing: -0.02em;
          margin-bottom: 1.5rem;
          text-align: center;
          background: linear-gradient(135deg, #60a5fa, #34d399);
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          background-clip: text;
        }
        .blog-container :global(h2) {
          font-size: 1.5rem;
          color: #60a5fa;
          font-weight: 600;
          margin-top: 2.5rem;
          margin-bottom: 1rem;
          border-left: 4px solid #60a5fa;
          padding-left: 1rem;
        }
        .blog-container :global(p) { margin-bottom: 1.5rem; color: #cbd5e1; font-size: 1.1rem; }
        .blog-container :global(strong) { color: #f1f5f9; font-weight: 600; }
        .blog-container :global(em) { color: #94a3b8; font-style: italic; }
        .blog-container :global(p:last-child) {
          text-align: center; font-style: italic; color: #10b981; font-size: 1.2rem; margin-top: 2rem;
          padding: 1.5rem; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3);
          border-radius: 12px;
        }

        /* ===== SECTION WELCOME / DOWNLOADS ===== */
        .welcome-container {
          max-width: 800px;
          margin: 3rem auto 3rem;
          padding: 0rem 2rem;
          font-size: 15px;
          text-align: center;
          color: #f8fafc;
        }
        .welcome-container h1 {
          font-size: clamp(2rem, 5vw, 3rem);
          color: #f8fafc; font-weight: 700; letter-spacing: -0.02em; 
          margin-top: 4rem;
          margin-bottom: 2rem;
          display: flex; flex-direction: column; align-items: center; gap: 1rem;
        }
        .icon-books { font-size: clamp(3rem, 8vw, 5rem); filter: drop-shadow(0 4px 12px rgba(79, 142, 247, 0.3)); animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-10px); } }
        .intro { font-size: 1.25rem; color: #cbd5e1; margin: 2rem 0 3rem 0; font-weight: 500; }

        .downloads-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
          gap: 2rem;
          max-width: 900px;
          margin: 0 auto;
        }
        .download-card {
          background: rgba(30, 41, 59, 0.6);
          backdrop-filter: blur(10px);
          border: 1px solid rgba(255, 255, 255, 0.1);
          border-radius: 16px;
          padding: 2rem 1.5rem;
          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
          position: relative;
          overflow: hidden;
        }
        .download-card::before {
          content: '';
          position: absolute; top: 0; left: 0; right: 0; height: 3px;
          background: linear-gradient(90deg, var(--level-color), var(--level-color-light));
          opacity: 0.8;
        }
        .level-a1 { --level-color: #3b82f6; --level-color-light: #60a5fa; }
        .level-a2 { --level-color: #10b981; --level-color-light: #34d399; }
        .level-b1 { --level-color: #f59e0b; --level-color-light: #fbbf24; }

        .download-card:hover {
          transform: translateY(-8px);
          background: rgba(30, 41, 59, 0.8);
          border-color: rgba(255, 255, 255, 0.2);
          box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3),
                      0 10px 10px -5px rgba(0, 0, 0, 0.1),
                      0 0 0 1px rgba(255, 255, 255, 0.05);
        }
        .card-content { display: flex; flex-direction: column; align-items: center; gap: 1.5rem; }
        .download-card h3 { font-size: 1.25rem; font-weight: 600; color: #f1f5f9; margin: 0; letter-spacing: -0.01em; }
        .download-btn {
          display: inline-flex; align-items: center; justify-content: center;
          padding: 0.75rem 2rem; background: linear-gradient(135deg, var(--level-color), var(--level-color-light));
          color: white; text-decoration: none; border-radius: 12px; font-weight: 600; font-size: 1rem;
          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); border: none; cursor: pointer; min-width: 140px; letter-spacing: 0.01em;
        }
        .download-btn:hover,.download-btn:focus { transform: translateY(-2px); box-shadow: 0 12px 20px -5px rgba(0,0,0,.3); filter: brightness(1.1); outline: none; }
        .download-btn:active { transform: translateY(0); }
        .download-btn:disabled { opacity: .6; cursor: not-allowed; transform: none; }
        .download-btn.loading { position: relative; opacity: .9; }
        .download-btn.loading::after {
          content: ""; display: inline-block; width: 14px; height: 14px; margin-left: 8px; border-radius: 9999px;
          border: 2px solid rgba(255,255,255,.6); border-top-color: #fff; animation: spin .8s linear infinite; vertical-align: -2px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .download-container {
          margin-top: 1rem; padding: 1rem; background: rgba(16,185,129,.1);
          border: 1px solid rgba(16,185,129,.3); border-radius: 8px; display: none; animation: fadeIn .5s ease-in-out; width: 100%; text-align: center;
        }
        .download-container.show { display: block; }
        .download-container a { color: #10b981; text-decoration: none; font-weight: 600; }
        .download-container a:hover { text-decoration: underline; }
        .timer-text { color: #94a3b8; font-size: .875rem; margin-top: .5rem; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px);} to {opacity: 1; transform: translateY(0);} }

        /* ===== SECTION DERNIERS ARTICLES ===== */
        .latest-posts { max-width: 1100px; margin: 2rem auto 3rem; padding: 0 2rem; color: #f8fafc; }
        .latest-container {
          background: rgba(30, 41, 59, 0.6);
          border: 1px solid rgba(255,255,255,.1);
          border-radius: 16px;
          padding: 2rem;
        }
        .latest-container h2 { margin: 0 0 1rem 0; font-size: 1.5rem; color: #60a5fa; }
        .posts-grid {
          display: grid;
          grid-template-columns: repeat(3, 1fr);
          gap: 1.25rem;
        }
        .derniersarticles {
          text-align: center;
        }
        .post-card {
          background: rgba(15,23,42,.6);
          border: 1px solid rgba(255,255,255,.08);
          border-radius: 12px;
          overflow: hidden;
          transition: transform .2s ease;
        }
        .post-card:hover { transform: translateY(-4px); }
        .post-link { color: inherit; text-decoration: none; display: block; }
        .post-card img { width: 100%; height: auto; display: block; }
        .post-title { font-size: 1rem; margin: .75rem 1rem 0 1rem; color: #f8fafc; }
        .post-meta { font-size: .85rem; color: #cbd5e1; margin: .5rem 1rem 1rem 1rem; }

        /* Responsive */
        @media (max-width: 992px) { .posts-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 640px) { .posts-grid { grid-template-columns: 1fr; } }
      </style>
    </main>

    <Footer />

    <!-- ‚úÖ Banni√®re cookies -->
    <div id="cookie-banner" hidden>
      <span>Ce site utilise des cookies de mesure (Google Analytics) uniquement si vous acceptez.</span>
      <span class="actions">
        <button id="accept-cookies">Accepter</button>
        <button id="decline-cookies">Refuser</button>
      </span>
    </div>

    <!-- ‚úÖ Scripts -->
    <script src="/scripts/consent.js" defer></script>
    <script src="/scripts/ga-init.js" defer></script>
    <script src="/scripts/downloads.js" defer></script>
  </body>
</html>
