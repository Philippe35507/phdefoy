---
import BlogPost from '../layouts/BlogPost.astro';
import { getCollection, render, type CollectionEntry } from 'astro:content';

type Post = CollectionEntry<'blog'>;

export async function getStaticPaths() {
  // Fonction définie à l'intérieur pour être accessible au build
  const cleanSlug = (id: string) => id.replace(/^.*\//, '').replace(/^\d{4}-\d{2}-\d{2}-/, '');

  const posts = await getCollection('blog');
  return posts.map((post) => ({
    params: { slug: cleanSlug(post.id) },
    props: { post },
  }));
}

// Fonction pour nettoyer l'ID en slug (pour le runtime)
const cleanSlug = (id: string) => id.replace(/^.*\//, '').replace(/^\d{4}-\d{2}-\d{2}-/, '');

// En mode server, on doit chercher le post manuellement
let post: Post | undefined = Astro.props.post;

if (!post) {
  const { slug } = Astro.params;
  const posts = await getCollection('blog');
  post = posts.find((p) => cleanSlug(p.id) === slug);
}

if (!post) {
  return Astro.redirect('/404/');
}

const { Content } = await render(post);
const data = post.data as any;

const title = data.title ?? cleanSlug(post.id);
const description = data.description ?? '';
const heroImage = data.heroImage ?? data.image;
---

<BlogPost
  {...data}
  title={title}
  description={description}
  heroImage={heroImage}
>
  <Content />
</BlogPost>
